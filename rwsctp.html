<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Regional Weather Summary (RWSCTP)</title>

  <style>
    body { margin: 16px; }
    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      max-width: 1200px;
    }

    .nav-toggle { font-size: 0.95em; }
    .nav-toggle button {
      margin-left: 8px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #fff;
      cursor: pointer;
      font: inherit;
    }
    .nav-toggle button:hover { background: #f3f3f3; }

    .refresh-label { font-size: 0.95em; color: #333; }
    #refreshBtn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #fff;
      cursor: pointer;
      font: inherit;
    }
    #refreshBtn:hover { background: #f3f3f3; }
    #refreshBtn:disabled { opacity: 0.6; cursor: not-allowed; }

    .muted { color: #555; font-size: 0.95em; max-width: 1200px; }
    .section-title { margin-top: 14px; margin-bottom: 6px; }

    .panel {
      max-width: 1200px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 12px 14px;
      background: #fafafa;
    }
    .panel h2 {
      margin: 0 0 6px;
      font-size: 1.05em;
    }
    .meta {
      margin: 0 0 10px;
      color: #333;
      font-size: 0.95em;
    }
    pre {
      margin: 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      line-height: 1.35;
      font-size: 0.98em;
    }
    a { color: #1d4ed8; }
  </style>
</head>

<body>
  <h1>Regional Weather Summary (RWSCTP)</h1>

  <div class="controls">
    <div class="nav-toggle">
      Back to alerts?
      <button type="button" onclick="window.location.href='index.html'">Index</button>
      <button type="button" onclick="window.location.href='advisories.html'">Advisories</button>
    </div>
  </div>

  <div class="controls">
    <span class="refresh-label">Auto-refresh: every 5 minutes</span>
    <button id="refreshBtn" type="button">Refresh Now</button>
  </div>

  <p id="status" class="muted">Loading RWS…</p>

  <h2 class="section-title">Latest Text</h2>

  <div class="panel">
    <h2 id="prodTitle">RWS (CTP)</h2>
    <p id="prodMeta" class="meta">—</p>
    <pre id="prodText">Loading…</pre>
  </div>

  <p class="muted" style="margin-top:10px;">
    Source:
    <a id="listLink" href="#" target="_blank" rel="noopener noreferrer">NWS API (Products: RWS / CTP)</a>
    &nbsp;|&nbsp;
    <a id="prodLink" href="#" target="_blank" rel="noopener noreferrer">Latest product</a>
  </p>

  <script>
    // Correct endpoint order (type then location)
    // per Weather.gov API: /products/types/{typeId}/locations/{locationId}
    const LIST_URL = "https://api.weather.gov/products/types/RWS/locations/CTP";

    // Some products return JSON with @id, some with id; we handle both.
    function pickLatestProduct(items) {
      if (!Array.isArray(items) || items.length === 0) return null;

      // Prefer issuanceTime; fallback to whatever looks date-ish; else keep original order.
      const scored = items.map(p => {
        const t = Date.parse(p.issuanceTime || p.issueTime || p.validTime || p.created || "");
        return { p, t: isNaN(t) ? -1 : t };
      });

      scored.sort((a, b) => b.t - a.t);
      return scored[0].p;
    }

    function fmtTime(v) {
      if (!v) return "N/A";
      const d = new Date(v);
      return isNaN(d) ? String(v) : d.toLocaleString();
    }

    function cleanText(t) {
      return t ? String(t).replace(/\n{3,}/g, "\n\n").trim() : "No text returned.";
    }

    async function fetchJson(url) {
      const r = await fetch(url, { headers: { "Accept": "application/geo+json" } });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    async function fetchText(url) {
      // Product endpoint can return JSON with .productText; keep it JSON.
      const r = await fetch(url, { headers: { "Accept": "application/geo+json" } });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const d = await r.json();
      return d;
    }

    async function refreshRWS() {
      const status = document.getElementById("status");
      const btn = document.getElementById("refreshBtn");
      btn.disabled = true;
      status.textContent = "Loading RWS…";

      try {
        document.getElementById("listLink").href = LIST_URL;

        const listing = await fetchJson(LIST_URL);

        // Weather.gov product listing typically has an "products" array (OpenAPI shows this endpoint)
        const products = listing.products || listing["@graph"] || listing.items || [];
        const latest = pickLatestProduct(products);

        if (!latest) {
          status.textContent = `Last updated: ${new Date().toLocaleString()} | No RWS products found.`;
          document.getElementById("prodText").textContent = "No RWS products returned for CTP.";
          document.getElementById("prodLink").href = "#";
          document.getElementById("prodMeta").textContent = "—";
          return;
        }

        const latestUrl =
          latest["@id"] ||
          latest.id ||
          latest.url ||
          (latest.productId ? `https://api.weather.gov/products/${latest.productId}` : null);

        if (!latestUrl) {
          status.textContent = `Last updated: ${new Date().toLocaleString()} | Found a product, but no URL to fetch.`;
          document.getElementById("prodText").textContent = JSON.stringify(latest, null, 2);
          document.getElementById("prodLink").href = "#";
          return;
        }

        document.getElementById("prodLink").href = latestUrl;

        const prod = await fetchText(latestUrl);

        const wmo = prod.wmoCollectiveId || prod.wmoId || "";
        const awips = prod.awipsId || prod.productCode || "";
        const issued = prod.issuanceTime || prod.issueTime || latest.issuanceTime || "";

        const titleBits = [];
        if (prod.productName) titleBits.push(prod.productName);
        else titleBits.push("Regional Weather Summary");
        titleBits.push("CTP");

        document.getElementById("prodTitle").textContent = titleBits.join(" — ");
        document.getElementById("prodMeta").textContent =
          `Issued: ${fmtTime(issued)}`
          + (wmo ? ` | WMO: ${wmo}` : "")
          + (awips ? ` | AWIPS: ${awips}` : "");

        document.getElementById("prodText").textContent = cleanText(prod.productText || prod.text || "");

        status.textContent = `Last updated: ${new Date().toLocaleString()}`;

      } catch (err) {
        console.error(err);
        status.textContent = `Error loading RWS: ${err.message}`;
        document.getElementById("prodText").textContent = "Error loading RWS text.";
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", refreshRWS);

    refreshRWS();
    setInterval(refreshRWS, 5 * 60 * 1000);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Regional Weather Summary (RWSCTP)</title>

  <style>
    /* Keep styling consistent with your alert pages */
    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
      flex-wrap: wrap;
      max-width: 1200px;
    }

    .refresh-label { font-size: 0.95em; color: #333; }

    /* Small gray pill refresh button — same look as your pages */
    #refreshBtn {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid #aaa;
      background: #e9e9e9;
      cursor: pointer;
      font: inherit;
      line-height: 1.2;
    }
    #refreshBtn:hover { background: #dedede; }
    #refreshBtn:disabled { opacity: 0.6; cursor: not-allowed; }

    .muted { color: #555; font-size: 0.95em; }

    .wrap {
      max-width: 1200px;
      width: 100%;
    }

    /* “Similar to map”: a bordered, max-width content panel */
    .panel {
      max-width: 1200px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      padding: 10px 12px;
      box-sizing: border-box;
    }

    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 0.98em;
      line-height: 1.35;
    }

    body { margin: 16px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Regional Weather Summary (RWSCTP)</h1>

    <div class="controls">
      <span class="refresh-label">Auto-refresh: every 5 minutes</span>
      <button id="refreshBtn" type="button">Refresh Now</button>
    </div>

    <p id="status">Loading…</p>

    <h2 style="margin-top: 14px; margin-bottom: 6px;">Latest Text</h2>
    <div class="panel">
      <pre id="rwsText">Loading…</pre>
    </div>

    <p class="muted" style="margin-top: 10px;">
      Source:
      <a id="sourceLink" href="#" target="_blank" rel="noopener noreferrer">NWS API (RWS / CTP)</a>
    </p>
  </div>

  <script>
    // Pull the latest RWS product for WFO CTP
    // NWS endpoint: list products by type + location; newest is first (usually)
    const LIST_URL = "https://api.weather.gov/products/types/RWS/locations/CTP";
    const REFRESH_MS = 5 * 60 * 1000;

    function formatTime(v) {
      if (!v) return "N/A";
      const d = new Date(v);
      return isNaN(d) ? String(v) : d.toLocaleString();
    }

    function cleanText(t) {
      return t ? t.replace(/\n{3,}/g, "\n\n").trim() : "No text available.";
    }

    async function fetchLatestRWS() {
      const status = document.getElementById("status");
      const btn = document.getElementById("refreshBtn");
      const pre = document.getElementById("rwsText");
      const link = document.getElementById("sourceLink");

      btn.disabled = true;
      status.textContent = "Loading…";
      pre.textContent = "Loading…";

      try {
        const r = await fetch(LIST_URL, { headers: { "Accept": "application/geo+json" } });
        if (!r.ok) throw new Error("HTTP " + r.status);
        const d = await r.json();

        // API returns: { @context, type, ... , "@graph": [ { id, issuanceTime, productCode, ... } ] }
        const graph = Array.isArray(d["@graph"]) ? d["@graph"] : [];
        if (!graph.length || !graph[0].id) {
          status.textContent = "No RWS products found.";
          pre.textContent = "No RWS products found for CTP.";
          link.href = LIST_URL;
          return;
        }

        const latest = graph[0];
        const productUrl = latest.id;

        // Fetch the actual product (contains .productText)
        const r2 = await fetch(productUrl, { headers: { "Accept": "application/geo+json" } });
        if (!r2.ok) throw new Error("HTTP " + r2.status);
        const p = await r2.json();

        const text = cleanText(p.productText);
        pre.textContent = text;

        // Status line similar to your pages
        const issued = latest.issuanceTime || p.issuanceTime;
        status.textContent = `Last updated: ${new Date().toLocaleString()} | Issued: ${formatTime(issued)}`;

        link.href = productUrl;

      } catch (err) {
        console.error(err);
        status.textContent = "Error loading RWS: " + err.message;
        pre.textContent = "Error loading RWS text.";
        document.getElementById("sourceLink").href = LIST_URL;
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById("refreshBtn").onclick = fetchLatestRWS;

    fetchLatestRWS();
    setInterval(fetchLatestRWS, REFRESH_MS);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PA Weather Watches & Warnings</title>
</head>
<body>
  <h1>PA Weather Watches & Warnings</h1>

  <button id="refreshBtn">Refresh Now</button>
  <p id="status">Loading alerts…</p>

  <div id="tableContainer"></div>

  <script>
    const API_URL = "https://api.weather.gov/alerts/active?area=PA";

    // Cache zone lookups: zone URL -> { name, state }
    const zoneCache = new Map();

    function formatTime(isoString) {
      if (!isoString) return "N/A";
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return isoString;
      return d.toLocaleString(undefined, {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "numeric",
        minute: "2-digit",
        second: "2-digit",
        hour12: true
      });
    }

    function isWatchOrWarning(p) {
      const event = (p.event || "").toLowerCase();

      const isWanted =
        event.includes("watch") ||
        event.includes("warning") ||
        event.includes("emergency");

      const isUnwanted =
        event.includes("advisory") ||
        event.includes("statement") ||
        event.includes("outlook") ||
        event.includes("test");

      return isWanted && !isUnwanted;
    }

    async function getZoneInfo(zoneUrl) {
      if (zoneCache.has(zoneUrl)) return zoneCache.get(zoneUrl);

      try {
        const resp = await fetch(zoneUrl, { headers: { "Accept": "application/geo+json" } });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        const info = {
          name: data?.properties?.name || zoneUrl,
          state: data?.properties?.state || null
        };

        zoneCache.set(zoneUrl, info);
        return info;
      } catch {
        const info = { name: zoneUrl, state: null };
        zoneCache.set(zoneUrl, info);
        return info;
      }
    }

    // Returns { paNames: string[], hasPA: boolean }
    async function getPALocationsFromAffectedZones(p) {
      const zones = Array.isArray(p.affectedZones) ? p.affectedZones : [];
      if (!zones.length) return { paNames: [], hasPA: false };

      const infos = await Promise.all(zones.map(getZoneInfo));

      // Keep only zones explicitly tagged as PA by NWS zone metadata
      const paNames = infos
        .filter(z => z && z.state === "PA")
        .map(z => z.name);

      // Dedup
      const seen = new Set();
      const unique = paNames.filter(n => (seen.has(n) ? false : (seen.add(n), true)));

      return { paNames: unique, hasPA: unique.length > 0 };
    }

    function renderTable(rowsHtml) {
      const container = document.getElementById("tableContainer");
      if (!rowsHtml) {
        container.innerHTML = "<p>No active watches or warnings for PA.</p>";
        return;
      }

      container.innerHTML = `
        <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%; max-width: 1200px;">
          <thead>
            <tr>
              <th>Type</th>
              <th>Locations (PA only)</th>
              <th>Expires</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      `;
    }

    async function fetchAlerts() {
      const statusEl = document.getElementById("status");
      const refreshBtn = document.getElementById("refreshBtn");

      refreshBtn.disabled = true;
      statusEl.textContent = "Loading alerts…";

      try {
        const response = await fetch(API_URL, { headers: { "Accept": "application/geo+json" } });
        if (!response.ok) throw new Error("HTTP " + response.status);

        const data = await response.json();
        const features = Array.isArray(data.features) ? data.features : [];

        // Watches/warnings only first
        const wwAll = features.filter(f => f?.properties && isWatchOrWarning(f.properties));

        // For each alert, compute PA-only locations using authoritative zone metadata
        const enriched = await Promise.all(wwAll.map(async (f) => {
          const p = f.properties || {};
          const pa = await getPALocationsFromAffectedZones(p);
          return { feature: f, props: p, paNames: pa.paNames, hasPA: pa.hasPA };
        }));

        // Keep only alerts with at least one PA zone
        const paOnly = enriched.filter(x => x.hasPA);

        // Sort by expiration soonest first
        paOnly.sort((a, b) => {
          const ae = new Date(a.props.ends || a.props.expires || 0).getTime();
          const be = new Date(b.props.ends || b.props.expires || 0).getTime();
          return ae - be;
        });

        if (!paOnly.length) {
          renderTable("");
          statusEl.textContent =
            "Last updated: " + new Date().toLocaleString() + " | Alerts: 0";
          return;
        }

        const rows = paOnly.map(x => {
          const event = x.props.event || "Unknown";
          const expiresIso = x.props.ends || x.props.expires || null;
          const expiresStr = formatTime(expiresIso);
          const locations = x.paNames.join("; ");

          return `<tr>
            <td>${event}</td>
            <td>${locations || "—"}</td>
            <td>${expiresStr}</td>
          </tr>`;
        }).join("");

        renderTable(rows);

        statusEl.textContent =
          "Last updated: " + new Date().toLocaleString() + " | Alerts: " + paOnly.length;

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error loading alerts: " + err.message;
        document.getElementById("tableContainer").innerHTML =
          "<p>Error loading alerts. Check console/network access to api.weather.gov.</p>";
      } finally {
        refreshBtn.disabled = false;
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", fetchAlerts);
    fetchAlerts();
    setInterval(fetchAlerts, 5 * 60 * 1000);
  </script>
</body>
</html>
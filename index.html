<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PA Weather Watches & Warnings</title>
</head>
<body>
  <h1>PA Weather Watches & Warnings</h1>

  <button id="refreshBtn">Refresh Now</button>
  <p id="status">Loading alertsâ€¦</p>

  <div id="tableContainer"></div>

  <script>
    const API_URL = "https://api.weather.gov/alerts/active?area=PA";

    // Cache zone lookups: zone URL -> { name, state }
    const zoneCache = new Map();

    function formatTime(isoStringOrMs) {
      if (isoStringOrMs === null || isoStringOrMs === undefined) return "N/A";
      const d = (typeof isoStringOrMs === "number") ? new Date(isoStringOrMs) : new Date(isoStringOrMs);
      if (isNaN(d.getTime())) return String(isoStringOrMs);
      return d.toLocaleString(undefined, {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "numeric",
        minute: "2-digit",
        second: "2-digit",
        hour12: true
      });
    }

    function isWatchOrWarning(p) {
      const event = (p.event || "").toLowerCase();

      const isWanted =
        event.includes("watch") ||
        event.includes("warning") ||
        event.includes("emergency");

      const isUnwanted =
        event.includes("advisory") ||
        event.includes("statement") ||
        event.includes("outlook") ||
        event.includes("test");

      return isWanted && !isUnwanted;
    }

    // Normalize expiration to a millisecond timestamp so "same time" groups correctly
    function getExpiresMs(p) {
      const raw = p.ends || p.expires || null;
      if (!raw) return null;
      const ms = new Date(raw).getTime();
      return isNaN(ms) ? null : ms;
    }

    async function getZoneInfo(zoneUrl) {
      if (zoneCache.has(zoneUrl)) return zoneCache.get(zoneUrl);

      try {
        const resp = await fetch(zoneUrl, { headers: { "Accept": "application/geo+json" } });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        const info = {
          name: data?.properties?.name || zoneUrl,
          state: data?.properties
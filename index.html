<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PA Weather Watches & Warnings</title>
</head>
<body>
  <h1>PA Weather Watches & Warnings</h1>

  <button id="refreshBtn">Refresh Now</button>
  <p id="status">Loading alerts…</p>

  <div id="tableContainer"></div>

  <script>
    const API_URL = "https://api.weather.gov/alerts/active?area=PA";

    // Cache zone lookups so we don't hammer the API
    const zoneNameCache = new Map(); // key: zone URL -> value: zone name

    function formatTime(isoString) {
      if (!isoString) return "N/A";
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return isoString;
      return d.toLocaleString(undefined, {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "numeric",
        minute: "2-digit",
        second: "2-digit",
        hour12: true
      });
    }

    function isWatchOrWarning(p) {
      const event = (p.event || "").toLowerCase();

      const isWanted =
        event.includes("watch") ||
        event.includes("warning") ||
        event.includes("emergency");

      const isUnwanted =
        event.includes("advisory") ||
        event.includes("statement") ||
        event.includes("outlook") ||
        event.includes("test");

      return isWanted && !isUnwanted;
    }

    function getUGCList(p) {
      return (p.geocode && Array.isArray(p.geocode.ugc)) ? p.geocode.ugc : [];
    }

    // Convert UGC code to a zone URL (best-effort)
    function ugcToZoneUrl(ugc) {
      // UGC like "PAZ006" or "PAC071"
      if (typeof ugc !== "string" || ugc.length < 6) return null;
      const third = ugc[2]; // 'Z' or 'C'
      if (third === "Z") return `https://api.weather.gov/zones/forecast/${ugc}`;
      if (third === "C") return `https://api.weather.gov/zones/county/${ugc}`;
      return null;
    }

    // Pull PA-relevant zone URLs from affectedZones and/or UGC
    function getPAZoneUrls(p) {
      const urls = new Set();

      // 1) Prefer affectedZones (most reliable)
      if (Array.isArray(p.affectedZones)) {
        for (const z of p.affectedZones) {
          if (typeof z !== "string") continue;
          // Keep only PA forecast/county zones
          if (z.includes("/zones/forecast/PAZ") || z.includes("/zones/county/PAC")) {
            urls.add(z);
          }
        }
      }

      // 2) Fallback: derive from UGC if present
      for (const ugc of getUGCList(p)) {
        if (typeof ugc === "string" && ugc.startsWith("PA")) {
          const url = ugcToZoneUrl(ugc);
          if (url) urls.add(url);
        }
      }

      return Array.from(urls);
    }

    // Keep alert if it touches any PA zone/county
    function isPennsylvaniaAlert(p) {
      return getPAZoneUrls(p).length > 0;
    }

    async function lookupZoneName(zoneUrl) {
      if (zoneNameCache.has(zoneUrl)) return zoneNameCache.get(zoneUrl);

      try {
        const resp = await fetch(zoneUrl, { headers: { "Accept": "application/geo+json" } });
        if (!resp.ok) throw new Error(`Zone lookup HTTP ${resp.status}`);
        const data = await resp.json();
        const name = data?.properties?.name || zoneUrl;
        zoneNameCache.set(zoneUrl, name);
        return name;
      } catch {
        zoneNameCache.set(zoneUrl, zoneUrl);
        return zoneUrl;
      }
    }

    async function getPALocationsString(p) {
      const paZoneUrls = getPAZoneUrls(p);

      // If for some reason we kept it but didn't get urls, fall back to areaDesc
      if (!paZoneUrls.length) return p.areaDesc || "—";

      const names = await Promise.all(paZoneUrls.map(lookupZoneName));

      // Deduplicate while preserving order
      const seen = new Set();
      const unique = names.filter(n => {
        if (seen.has(n)) return false;
        seen.add(n);
        return true;
      });

      return unique.join("; ");
    }

    function renderTable(rowsHtml) {
      const container = document.getElementById("tableContainer");

      if (!rowsHtml) {
        container.innerHTML = "<p>No active watches or warnings for PA.</p>";
        return;
      }

      container.innerHTML = `
        <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; width: 100%; max-width: 1200px;">
          <thead>
            <tr>
              <th>Type</th>
              <th>Locations (PA only)</th>
              <th>Expires</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
      `;
    }

    async function fetchAlerts() {
      const statusEl = document.getElementById("status");
      const refreshBtn = document.getElementById("refreshBtn");

      refreshBtn.disabled = true;
      statusEl.textContent = "Loading alerts…";

      try {
        const response = await fetch(API_URL, { headers: { "Accept": "application/geo+json" } });
        if (!response.ok) throw new Error("HTTP " + response.status);

        const data = await response.json();
        const features = Array.isArray(data.features) ? data.features : [];

        // First: watches/warnings only
        const wwAll = features.filter(f => f?.properties && isWatchOrWarning(f.properties));

        // Then: must touch PA (via affectedZones preferred)
        const paOnly = wwAll.filter(f => isPennsylvaniaAlert(f.properties));

        // Sort by expiration (soonest first)
        paOnly.sort((a, b) => {
          const ap = a.properties || {};
          const bp = b.properties || {};
          const ae = new Date(ap.ends || ap.expires || 0).getTime();
          const be = new Date(bp.ends || bp.expires || 0).getTime();
          return ae - be;
        });

        if (!paOnly.length) {
          renderTable("");
          statusEl.textContent = "Last updated: " + new Date().toLocaleString() + " | Alerts: 0";
          return;
        }

        const rows = await Promise.all(paOnly.map(async (f) => {
          const p = f.properties || {};
          const event = p.event || "Unknown";
          const expiresIso = p.ends || p.expires || null;
          const expiresStr = formatTime(expiresIso);

          const paLocations = await getPALocationsString(p);

          return `<tr>
            <td>${event}</td>
            <td>${paLocations}</td>
            <td>${expiresStr}</td>
          </tr>`;
        }));

        renderTable(rows.join(""));

        statusEl.textContent =
          "Last updated: " + new Date().toLocaleString() + " | Alerts: " + paOnly.length;

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error loading alerts: " + err.message;
        document.getElementById("tableContainer").innerHTML =
          "<p>Error loading alerts. Check console/network access to api.weather.gov.</p>";
      } finally {
        refreshBtn.disabled = false;
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", fetchAlerts);
    fetchAlerts();
    setInterval(fetchAlerts, 5 * 60 * 1000);
  </script>
</body>
</html>